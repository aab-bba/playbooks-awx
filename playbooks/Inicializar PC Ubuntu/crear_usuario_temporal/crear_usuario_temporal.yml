# playbooks/crear_usuario_temporal.yml
- name: Añadir usuario temporal con sudo
  hosts: all
  become: true

  vars:
    db_name: aula_monitor
    db_host: localhost
    equipo_id: "{{ hostvars[inventory_hostname].equipo_id }}"
    usuario_temporal: ansible_temp

  tasks:
    - name: Crear usuario temporal
      ansible.builtin.user:
        name: "{{ usuario_temporal }}"
        password: "{{ ansible_temp_password }}"
        shell: /bin/bash
        state: present

    - name: Dar permisos de sudo sin contraseña
      ansible.builtin.lineinfile:
        path: /etc/sudoers.d/{{ usuario_temporal }}
        create: yes
        mode: '0440'
        line: "{{ usuario_temporal }} ALL=(ALL) NOPASSWD:ALL"
        validate: 'visudo -cf %s'

    - name: Insertar resultado en la base de datos
      community.mysql.mysql_query:
        login_host: "{{ db_host }}"
        login_user: "{{ db_user }}"
        login_password: "{{ db_password }}"
        login_db: "{{ db_name }}"
        query: >
          INSERT INTO tareas (equipo_id, tarea, resultado)
          VALUES (
            {{ equipo_id }},
            'crear usuario temporal',
            'Usuario {{ usuario_temporal }} creado con permisos sudo'
          )
      delegate_to: localhost
